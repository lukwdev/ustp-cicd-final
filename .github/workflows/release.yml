name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    needs: build-and-test # Wait for the build job in THIS workflow run
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-app-bundle-ubuntu-latest
          path: ./release-assets

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: USTP CI/CD Tetris ${{ github.ref_name }}
          files: ./release-assets/**
          generate_release_notes: true
          draft: false
          prerelease: false

  # Define the Build job here (or rely on the separate Build workflow).
  # However, relying on a SEPARATE workflow for releases is tricky because
  # 'download-artifact' defaults to the CURRENT run.
  # The cleanest way for Releases is to include the build steps or use 'needs' if in same file.
  # Since we want to avoid code duplication, we assume the 'Build' workflow triggered
  # by the tag runs PARALLEL to this.
  # BUT 'download-artifact' cannot easily cross workflows without an ID.

  # FIX: To make this work seamlessly with "No Duplication",
  # we simply grab the artifacts from the "Build" workflow that ran for this tag.

  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Build (Manual check or sleep not recommended, but simple for this demo)
        run: echo "Ideally, Release should be a job INSIDE build.yml to share artifacts easily."
